@page "/timeline"
@inject IStorageService Storage
@using System.Text.RegularExpressions
@using System.Linq

<MudStack Spacing="4" Class="page-stack">
    <div class="timeline-header">
        <MudText Typo="Typo.h5"><strong>Timeline</strong></MudText>
        <MudText Typo="Typo.body2" Class="muted">Browse and search your journal entries</MudText>
    </div>

    <!-- Search Section -->
    <MudPaper Class="filters-paper" Elevation="3">
        <MudStack Spacing="3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Medium" />
                <MudText Typo="Typo.h6"><strong>Search Entries</strong></MudText>
            </MudStack>
            
            <MudTextField T="string" 
                         Value="@_searchTerm"
                         ValueChanged="@OnSearchChanged"
                         Label="Search" 
                         Placeholder="Title or content" 
                         Variant="Variant.Outlined"
                         FullWidth="true"
                         Clearable="true"
                         OnClearButtonClick="@ClearSearch" />
        </MudStack>
    </MudPaper>

    <!-- Filters Section -->
    <MudPaper Class="filters-paper" Elevation="3">
        <MudStack Spacing="3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.FilterList" Size="Size.Medium" />
                <MudText Typo="Typo.h6"><strong>Filter Entries</strong></MudText>
                <MudSpacer />
                @if (_hasActiveFilters)
                {
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Error" 
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.ClearAll"
                               OnClick="@ResetFilters">
                        Clear Filters
                    </MudButton>
                }
            </MudStack>

            <!-- Filter Controls Row -->
            <MudGrid Spacing="2">
                <!-- Mood Filter -->
                <MudItem xs="12" sm="6" md="3">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Class="filter-label"><strong>Mood (@_availableMoods.Count)</strong></MudText>
                        @if (_availableMoods?.Count > 0)
                        {
                            <MudSelect T="string" 
                                       Value="@_selectedMood"
                                       ValueChanged="@OnMoodChanged"
                                       Label="Filter by mood"
                                       Variant="Variant.Outlined"
                                       Clearable="true">
                                @foreach (var mood in _availableMoods.OrderBy(m => m))
                                {
                                    <MudSelectItem T="string" Value="@mood">@mood</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="muted">No moods in database</MudText>
                        }
                    </MudStack>
                </MudItem>

                <!-- Secondary Mood Filter -->
                <MudItem xs="12" sm="6" md="3">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Class="filter-label"><strong>Secondary (@_availableSecondaryMoods.Count)</strong></MudText>
                        @if (_availableSecondaryMoods?.Count > 0)
                        {
                            <MudSelect T="string" 
                                       Value="@_selectedSecondaryMood"
                                       ValueChanged="@OnSecondaryMoodChanged"
                                       Label="Filter by secondary"
                                       Variant="Variant.Outlined"
                                       Clearable="true">
                                @foreach (var mood in _availableSecondaryMoods.OrderBy(m => m))
                                {
                                    <MudSelectItem T="string" Value="@mood">@mood</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="muted">No secondary moods</MudText>
                        }
                    </MudStack>
                </MudItem>

                <!-- Tags Filter -->
                <MudItem xs="12" sm="6" md="3">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Class="filter-label"><strong>Tags (@_availableTags.Count)</strong></MudText>
                        @if (_availableTags?.Count > 0)
                        {
                            <MudSelect T="string" 
                                       Value="@_selectedTag"
                                       ValueChanged="@OnTagChanged"
                                       Label="Filter by tag"
                                       Variant="Variant.Outlined"
                                       Clearable="true">
                                @foreach (var tag in _availableTags)
                                {
                                    <MudSelectItem T="string" Value="@tag.Name">@tag.Name</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="muted">No tags available</MudText>
                        }
                    </MudStack>
                </MudItem>

                <!-- Date Range Filter -->
                <MudItem xs="12" sm="6" md="3">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Class="filter-label"><strong>Date Range</strong></MudText>
                        <MudButton Variant="Variant.Outlined" 
                                   Size="Size.Small"
                                   FullWidth="true"
                                   OnClick="@ToggleDatePicker"
                                   StartIcon="@Icons.Material.Filled.DateRange">
                            @if (_showDatePicker)
                            {
                                <span>@_startDate?.ToString("MMM dd") - @_endDate?.ToString("MMM dd")</span>
                            }
                            else
                            {
                                <span>Select Dates</span>
                            }
                        </MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>

            <!-- Date Picker (Collapsible) -->
            @if (_showDatePicker)
            {
                <MudDivider Class="my-2" />
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End">
                    <MudDatePicker Value="@_startDate"
                                   ValueChanged="@OnStartDateChanged"
                                   Label="Start Date"
                                   Variant="Variant.Outlined" />
                    <MudDatePicker Value="@_endDate"
                                   ValueChanged="@OnEndDateChanged"
                                   Label="End Date"
                                   Variant="Variant.Outlined" />
                    <MudButton Variant="Variant.Text"
                               Color="Color.Secondary"
                               Size="Size.Small"
                               OnClick="@ToggleDatePicker">
                        Done
                    </MudButton>
                </MudStack>
            }

            <!-- Active Filters Display -->
            @if (_hasActiveFilters)
            {
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                    <MudText Typo="Typo.caption" Class="filter-label">Active filters:</MudText>
                    @if (!string.IsNullOrEmpty(_selectedMood))
                    {
                        <MudChip T="string" Color="Color.Primary" OnClose="@(() => OnMoodChanged(""))">
                            Mood: @_selectedMood
                        </MudChip>
                    }
                    @if (!string.IsNullOrEmpty(_selectedSecondaryMood))
                    {
                        <MudChip T="string" Color="Color.Secondary" OnClose="@(() => OnSecondaryMoodChanged(""))">
                            Secondary: @_selectedSecondaryMood
                        </MudChip>
                    }
                    @if (!string.IsNullOrEmpty(_selectedTag))
                    {
                        <MudChip T="string" Color="Color.Info" OnClose="@(() => OnTagChanged(""))">
                            Tag: @_selectedTag
                        </MudChip>
                    }
                    @if (_startDate.HasValue || _endDate.HasValue)
                    {
                        <MudChip T="string" Color="Color.Warning" OnClose="@(() => { _startDate = null; _endDate = null; ApplyFilters(); })">
                            Dates: @_startDate?.ToString("MMM dd") - @_endDate?.ToString("MMM dd")
                        </MudChip>
                    }
                </MudStack>
            }
        </MudStack>
    </MudPaper>

    <!-- Results Info -->
    @if (_hasActiveFilters || !string.IsNullOrEmpty(_searchTerm))
    {
        <MudText Typo="Typo.body2" Class="muted">
            Found @_displayEntries.Count entry(@(_displayEntries.Count != 1 ? "ies" : ""))
            @if (!string.IsNullOrEmpty(_searchTerm))
            {
                <span>matching "@_searchTerm"</span>
            }
            @if (_hasActiveFilters)
            {
                <span>with active filters</span>
            }
        </MudText>
    }

    <!-- Entry Cards Grid -->
    @if (_displayEntries.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
            @if (string.IsNullOrEmpty(_searchTerm) && !_hasActiveFilters)
            {
                <span>No entries yet. Start journaling in the <strong>Today</strong> section!</span>
            }
            else if (_hasActiveFilters || !string.IsNullOrEmpty(_searchTerm))
            {
                <span>No entries found matching your search or filters. Try adjusting your criteria.</span>
            }
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3" Class="entries-grid">
            @foreach (var entry in _displayEntries)
            {
                <MudItem xs="12" sm="12" md="4" lg="4">
                    <MudPaper Class="entry-card" Elevation="3">
                        <MudStack Spacing="3" Style="height: 100%;">
                            <!-- Header -->
                            <div>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Wrap="Wrap.Wrap">
                                    <MudText Typo="Typo.subtitle2"><strong>@entry.Date.ToString("MMM dd, yyyy")</strong></MudText>
                                    @if (!string.IsNullOrEmpty(entry.Mood))
                                    {
                                        <MudChip T="string" Value="@entry.Mood" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">
                                            @entry.Mood
                                        </MudChip>
                                    }
                                    @if (!string.IsNullOrEmpty(entry.SecondaryMood))
                                    {
                                        <MudChip T="string" Value="@entry.SecondaryMood" Color="Color.Secondary" Variant="Variant.Filled" Size="Size.Small">
                                            @entry.SecondaryMood
                                        </MudChip>
                                    }
                                </MudStack>
                            </div>

                            <!-- Tags Display -->
                            @if (entry.Tags.Count > 0)
                            {
                                <div>
                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                                        <MudIcon Icon="@Icons.Material.Filled.Tag" Size="Size.Small" Class="muted" />
                                        @foreach (var tag in entry.Tags)
                                        {
                                            <MudChip T="string" Value="@tag" Variant="Variant.Filled" Size="Size.Small" Color="Color.Primary">
                                                @tag
                                            </MudChip>
                                        }
                                    </MudStack>
                                </div>
                            }

                            <!-- Title and Preview -->
                            <div>
                                <MudText Typo="Typo.h6" Class="truncate">
                                    <strong>@(string.IsNullOrEmpty(entry.Title) ? "Untitled" : entry.Title)</strong>
                                </MudText>
                                <MudText Typo="Typo.body2" Class="muted entry-snippet">
                                    @GetPreview(entry.Content)
                                </MudText>
                            </div>

                            <!-- Category and Word Count -->
                            <div>
                                @if (!string.IsNullOrEmpty(entry.Category))
                                {
                                    <MudText Typo="Typo.caption" Class="muted">
                                        <strong>Category:</strong> @entry.Category
                                    </MudText>
                                }
                                <MudText Typo="Typo.caption" Class="muted">
                                    <strong>Words:</strong> @GetWordCount(entry.Content)
                                </MudText>
                            </div>

                            <!-- Spacer -->
                            <MudSpacer />

                            <!-- Footer -->
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="footer-section">
                                <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary" Class="open-button">
                                    View Entry
                                </MudButton>
                                <MudText Typo="Typo.caption" Class="muted">@GetTimeAgo(entry.UpdatedAt)</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
</MudStack>

@code {
    private string _searchTerm = "";
    private string _selectedMood = "";
    private string _selectedSecondaryMood = "";
    private string _selectedTag = "";
    private DateTime? _startDate = null;
    private DateTime? _endDate = null;
    private bool _showDatePicker = false;

    private List<JournalEntry> _allEntries = new();
    private List<JournalEntry> _displayEntries = new();
    private List<Tag> _availableTags = new();
    private List<string> _availableMoods = new();
    private List<string> _availableSecondaryMoods = new();

    private bool _hasActiveFilters => !string.IsNullOrEmpty(_selectedMood) || 
                                      !string.IsNullOrEmpty(_selectedSecondaryMood) ||
                                      !string.IsNullOrEmpty(_selectedTag) ||
                                      _startDate.HasValue ||
                                      _endDate.HasValue;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await Storage.InitializeAsync();
            System.Diagnostics.Debug.WriteLine("✓ Storage initialized");
            
            await LoadAllEntries();
            System.Diagnostics.Debug.WriteLine($"✓ Entries loaded: {_allEntries.Count}");
            
            await LoadAvailableTags();
            System.Diagnostics.Debug.WriteLine($"✓ Tags loaded: {_availableTags.Count}");
            
            await LoadAvailableMoods();
            System.Diagnostics.Debug.WriteLine($"✓ Moods loaded - Primary: {_availableMoods.Count}, Secondary: {_availableSecondaryMoods.Count}");
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"✗ Error in OnInitializedAsync: {ex.Message}\n{ex.StackTrace}");
        }
    }

    private async Task LoadAllEntries()
    {
        try
        {
            var result = await Storage.GetAllEntriesAsync();
            
            if (result.Success && result.Data != null)
            {
                _allEntries = result.Data;
                _displayEntries = _allEntries.OrderByDescending(e => e.Date).ToList();
                
                // Debug: Show mood distribution
                var moodCounts = _allEntries
                    .Where(e => !string.IsNullOrEmpty(e.Mood))
                    .GroupBy(e => e.Mood)
                    .Select(g => $"{g.Key}({g.Count()})")
                    .ToList();
                    
                System.Diagnostics.Debug.WriteLine($"Mood distribution: {string.Join(", ", moodCounts)}");
            }
            else
            {
                _allEntries = new();
                _displayEntries = new();
                System.Diagnostics.Debug.WriteLine($"✗ GetAllEntriesAsync failed: {result?.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"✗ LoadAllEntries exception: {ex.Message}");
            _allEntries = new();
            _displayEntries = new();
        }
    }

    private async Task LoadAvailableTags()
    {
        try
        {
            var result = await Storage.GetAllTagsAsync();
            if (result.Success)
            {
                _availableTags = result.Data ?? new();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"✗ LoadAvailableTags error: {ex.Message}");
            _availableTags = new();
        }
    }

    /// <summary>
    /// Load unique moods from all journal entries in the database
    /// </summary>
    private async Task LoadAvailableMoods()
    {
        try
        {
            System.Diagnostics.Debug.WriteLine($"Loading moods from {_allEntries.Count} entries");
            
            // Get all unique primary moods from entries
            _availableMoods = _allEntries
                .Where(e => !string.IsNullOrEmpty(e.Mood))
                .Select(e => e.Mood!)
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(m => m)
                .ToList();

            // Get all unique secondary moods from entries
            _availableSecondaryMoods = _allEntries
                .Where(e => !string.IsNullOrEmpty(e.SecondaryMood))
                .Select(e => e.SecondaryMood!)
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(m => m)
                .ToList();
                
            System.Diagnostics.Debug.WriteLine($"Primary moods: {string.Join(", ", _availableMoods)}");
            System.Diagnostics.Debug.WriteLine($"Secondary moods: {string.Join(", ", _availableSecondaryMoods)}");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"✗ LoadAvailableMoods error: {ex.Message}");
            _availableMoods = new();
            _availableSecondaryMoods = new();
        }
    }

    // Filter change handlers
    private async Task OnSearchChanged(string value)
    {
        _searchTerm = value ?? "";
        await ApplyFilters();
    }

    private async Task OnMoodChanged(string value)
    {
        _selectedMood = value ?? "";
        await ApplyFilters();
    }

    private async Task OnSecondaryMoodChanged(string value)
    {
        _selectedSecondaryMood = value ?? "";
        await ApplyFilters();
    }

    private async Task OnTagChanged(string value)
    {
        _selectedTag = value ?? "";
        await ApplyFilters();
    }

    private async Task OnStartDateChanged(DateTime? value)
    {
        _startDate = value;
        await ApplyFilters();
    }

    private async Task OnEndDateChanged(DateTime? value)
    {
        _endDate = value;
        await ApplyFilters();
    }

    private async Task ApplyFilters()
    {
        var filtered = new List<JournalEntry>(_allEntries);

        // Apply search term
        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            var searchLower = _searchTerm.ToLower();
            filtered = filtered.Where(e =>
            {
                var titleMatch = e.Title?.ToLower().Contains(searchLower) ?? false;
                var cleanContent = StripHtml(e.Content);
                var contentMatch = cleanContent.ToLower().Contains(searchLower);
                return titleMatch || contentMatch;
            }).ToList();
        }

        // Apply mood filter
        if (!string.IsNullOrEmpty(_selectedMood))
        {
            filtered = filtered.Where(e => e.Mood == _selectedMood).ToList();
        }

        // Apply secondary mood filter
        if (!string.IsNullOrEmpty(_selectedSecondaryMood))
        {
            filtered = filtered.Where(e => e.SecondaryMood == _selectedSecondaryMood).ToList();
        }

        // Apply tag filter
        if (!string.IsNullOrEmpty(_selectedTag))
        {
            filtered = filtered.Where(e => e.Tags.Contains(_selectedTag)).ToList();
        }

        // Apply date range filter
        if (_startDate.HasValue || _endDate.HasValue)
        {
            filtered = filtered.Where(e =>
            {
                var entryDate = e.Date;
                var startDateOnly = _startDate.HasValue ? DateOnly.FromDateTime(_startDate.Value) : DateOnly.MinValue;
                var endDateOnly = _endDate.HasValue ? DateOnly.FromDateTime(_endDate.Value) : DateOnly.MaxValue;
                var startMatch = !_startDate.HasValue || entryDate >= startDateOnly;
                var endMatch = !_endDate.HasValue || entryDate <= endDateOnly;
                return startMatch && endMatch;
            }).ToList();
        }

        _displayEntries = filtered.OrderByDescending(e => e.Date).ToList();
        StateHasChanged();
    }

    /// <summary>
    /// Strips HTML tags and cleans up whitespace from content
    /// </summary>
    private string StripHtml(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        
        // Remove all HTML tags
        var text = Regex.Replace(content, "<[^>]*>", " ");
        
        // Replace multiple spaces with single space
        text = Regex.Replace(text, @"\s+", " ");
        
        return text.Trim();
    }

    /// <summary>
    /// Gets a clean text preview, stripping HTML tags
    /// </summary>
    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        
        // Strip HTML tags first
        var cleanText = StripHtml(content);
        
        if (string.IsNullOrEmpty(cleanText)) return "[No content]";
        
        // Return preview (max 150 chars)
        if (cleanText.Length > 150)
            return cleanText.Substring(0, 150) + "...";
        
        return cleanText;
    }

    /// <summary>
    /// Calculates actual word count excluding HTML tags
    /// </summary>
    private int GetWordCount(string content)
    {
        if (string.IsNullOrEmpty(content)) return 0;
        
        // Strip HTML tags first
        var cleanText = StripHtml(content);
        
        if (string.IsNullOrEmpty(cleanText)) return 0;
        
        return cleanText.Split(new[] { ' ', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private void ToggleDatePicker()
    {
        _showDatePicker = !_showDatePicker;
    }

    private async Task ClearSearch()
    {
        _searchTerm = "";
        await ApplyFilters();
    }

    private async Task ResetFilters()
    {
        _selectedMood = "";
        _selectedSecondaryMood = "";
        _selectedTag = "";
        _startDate = null;
        _endDate = null;
        _searchTerm = "";
        _showDatePicker = false;
        await ApplyFilters();
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;
        if (timeSpan.TotalSeconds < 60) return "Just now";
        if (timeSpan.TotalMinutes < 60) return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24) return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7) return $"{(int)timeSpan.TotalDays}d ago";
        return dateTime.ToString("MMM dd");
    }
}

<style>
.page-stack {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
}

.timeline-header {
    padding: 1.5rem 0;
}

.muted {
    opacity: 0.7;
}

.filters-paper {
    padding: 2rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

:deep(.mud-dark .filters-paper) {
    background-color: #424242 !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;
}

.filter-label {
    display: inline-block;
    padding-bottom: 0.25rem;
    border-bottom: 2px solid rgba(25, 118, 210, 0.3);
}

.entries-grid {
    margin: 2rem 0;
}

.entry-card {
    padding: 1.75rem;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 320px;
}

.entry-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

:deep(.mud-dark .entry-card) {
    background-color: #424242 !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
}

:deep(.mud-dark .entry-card:hover) {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
}

.entry-snippet {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    max-height: 72px;
    line-height: 1.5;
}

.footer-section {
    padding-top: 1rem;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
}

:deep(.mud-dark .footer-section) {
    border-top-color: rgba(255, 255, 255, 0.12) !important;
}

.open-button {
    font-weight: 600 !important;
    transition: all 0.2s ease !important;
}

.open-button:hover {
    transform: translateX(2px);
}

.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.my-2 {
    margin: 0.5rem 0;
}
</style>
