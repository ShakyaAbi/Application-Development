@page "/dashboard"
@inject IStorageService Storage
@inject IJSRuntime JS
@inject IAuthenticationService AuthService
@inject IExportService ExportService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@using Courcework.Enums

<MudPaper Class="dashboard-hero" Elevation="4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <div>
            <MudText Typo="Typo.h3" Class="hero-title"><strong>Reflections Dashboard</strong></MudText>
            <MudText Typo="Typo.subtitle1" Class="muted">Your journaling insights at a glance.</MudText>
        </div>
        <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled">
            Analytics
        </MudChip>
    </MudStack>
</MudPaper>

<MudStack Spacing="4" Class="page-stack">
    <!-- Summary Cards -->
    <MudGrid Spacing="3">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="summary-card" Elevation="3">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.caption" Class="muted">Total Entries</MudText>
                    <MudText Typo="Typo.h4"><strong>@_totalEntries</strong></MudText>
                    <MudProgressLinear Value="@Math.Min(_totalEntries, 100)" Color="Color.Primary" Class="progress-bar" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="summary-card" Elevation="3">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.caption" Class="muted">Current Streak</MudText>
                    <MudText Typo="Typo.h4"><strong>@_currentStreak days</strong></MudText>
                    <MudProgressLinear Value="@Math.Min(_currentStreak * 10, 100)" Color="Color.Success" Class="progress-bar" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="summary-card" Elevation="3">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.caption" Class="muted">Longest Streak</MudText>
                    <MudText Typo="Typo.h4"><strong>@_longestStreak days</strong></MudText>
                    <MudProgressLinear Value="@Math.Min(_longestStreak * 10, 100)" Color="Color.Warning" Class="progress-bar" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="summary-card" Elevation="3">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.caption" Class="muted">Total Words</MudText>
                    <MudText Typo="Typo.h4"><strong>@_totalWords.ToString("N0")</strong></MudText>
                    <MudProgressLinear Value="@Math.Min((_totalWords / 10000) * 100, 100)" Color="Color.Info" Class="progress-bar" />
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Charts Section -->
    <MudGrid Spacing="3">
        <!-- Mood Distribution Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="chart-paper" Elevation="3">
                <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>Mood Distribution</strong></MudText>
                <div class="chart-container">
                    <canvas id="moodChart"></canvas>
                </div>
            </MudPaper>
        </MudItem>

        <!-- Writing Habits Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="chart-paper" Elevation="3">
                <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>Writing Habits</strong></MudText>
                <div class="chart-container">
                    <canvas id="habitChart"></canvas>
                </div>
            </MudPaper>
        </MudItem>

        <!-- ✅ Most Used Tags Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="chart-paper" Elevation="3">
                <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>Most Used Tags</strong></MudText>
                <div class="chart-container">
                    <canvas id="tagsChart"></canvas>
                </div>
            </MudPaper>
        </MudItem>

        <!-- ✅ Category Breakdown -->
        <MudItem xs="12" md="6">
            <MudPaper Class="chart-paper" Elevation="3">
                <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>Category Breakdown</strong></MudText>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Detailed Stats -->
    <MudGrid Spacing="3">
        <!-- Streak Visualization -->
        <MudItem xs="12" md="6">
            <MudPaper Class="details-paper" Elevation="3">
                <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>Streak Performance</strong></MudText>
                <MudStack Spacing="3" Class="mt-4">
                    <div class="stat-row">
                        <div class="stat-label">
                            <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" Class="fire-icon"></MudIcon>
                            <span>Current Streak</span>
                        </div>
                        <MudStack AlignItems="AlignItems.End">
                            <MudText Typo="Typo.h5"><strong>@_currentStreak</strong></MudText>
                            <MudText Typo="Typo.caption" Class="muted">days in a row</MudText>
                        </MudStack>
                    </div>

                    <MudDivider />

                    <div class="stat-row">
                        <div class="stat-label">
                            <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Class="trophy-icon"></MudIcon>
                            <span>Longest Streak</span>
                        </div>
                        <MudStack AlignItems="AlignItems.End">
                            <MudText Typo="Typo.h5"><strong>@_longestStreak</strong></MudText>
                            <MudText Typo="Typo.caption" Class="muted">best achievement</MudText>
                        </MudStack>
                    </div>

                    <MudDivider />

                    <div class="stat-row">
                        <div class="stat-label">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="trend-icon"></MudIcon>
                            <span>Consistency Score</span>
                        </div>
                        <MudStack AlignItems="AlignItems.End">
                            <MudText Typo="Typo.h5"><strong>@GetConsistencyScore()%</strong></MudText>
                            <MudText Typo="Typo.caption" Class="muted">current vs best</MudText>
                        </MudStack>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Writing Stats -->
        <MudItem xs="12" md="6">
            <MudPaper Class="details-paper" Elevation="3">
                <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>Writing Statistics</strong></MudText>
                <MudStack Spacing="3" Class="mt-4">
                    <div class="stat-row">
                        <div class="stat-label">
                            <MudIcon Icon="@Icons.Material.Filled.EditNote" Class="note-icon"></MudIcon>
                            <span>Avg Words per Entry</span>
                        </div>
                        <MudStack AlignItems="AlignItems.End">
                            <MudText Typo="Typo.h5"><strong>@GetAverageWordsPerEntry()</strong></MudText>
                            <MudText Typo="Typo.caption" Class="muted">words</MudText>
                        </MudStack>
                    </div>

                    <MudDivider />

                    <div class="stat-row">
                        <div class="stat-label">
                            <MudIcon Icon="@Icons.Material.Filled.DateRange" Class="date-icon"></MudIcon>
                            <span>Entries per Month</span>
                        </div>
                        <MudStack AlignItems="AlignItems.End">
                            <MudText Typo="Typo.h5"><strong>@GetEntriesPerMonth()</strong></MudText>
                            <MudText Typo="Typo.caption" Class="muted">average</MudText>
                        </MudStack>
                    </div>

                    <MudDivider />

                    <!-- ✅ MISSING DAYS STAT -->
                    <div class="stat-row">
                        <div class="stat-label">
                            <MudIcon Icon="@Icons.Material.Filled.HighlightOff" Class="missing-icon" Style="color: #ff9800;"></MudIcon>
                            <span>Missing Days</span>
                        </div>
                        <MudStack AlignItems="AlignItems.End">
                            <MudText Typo="Typo.h5"><strong>@GetMissingDays()</strong></MudText>
                            <MudText Typo="Typo.caption" Class="muted">skipped days</MudText>
                        </MudStack>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Recent Entries Table -->
    <MudPaper Class="recent-entries-paper" Elevation="3">
        <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>Recent Entries</strong></MudText>
        @if (_recentEntries.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
                No entries yet. Start journaling to see your data!
            </MudAlert>
        }
        else
        {
            <MudSimpleTable Style="overflow-x: auto;" Class="recent-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Title</th>
                        <th>Primary Mood</th>
                        <th>Secondary Mood</th>
                        <th>Words</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var entry in _recentEntries)
                    {
                        <tr>
                            <td>
                                <MudText Typo="Typo.body2">@entry.Date.ToString("MMM dd, yyyy")</MudText>
                            </td>
                            <td>
                                <MudText Typo="Typo.body2">
                                    <strong>@(string.IsNullOrEmpty(entry.Title) ? "Untitled" : entry.Title)</strong>
                                </MudText>
                            </td>
                            <td>
                                <MudChip T="string" Value="@(entry.Mood?.ToString() ?? "")" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small" Class="mood-chip">
                                    @(entry.Mood.HasValue ? entry.Mood.Value.ToString() : "—")
                                </MudChip>
                            </td>
                            <td>
                                <MudChip T="string" Value="@entry.SecondaryMood" Color="Color.Secondary" Variant="Variant.Filled" Size="Size.Small" Class="mood-chip">
                                    @(string.IsNullOrEmpty(entry.SecondaryMood) ? "—" : entry.SecondaryMood)
                                </MudChip>
                            </td>
                            <td>
                                <MudText Typo="Typo.body2">@GetWordCount(entry.Content)</MudText>
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
    </MudPaper>

    <!-- Export Data Section -->
    <MudPaper Class="export-section" Elevation="3">
        <MudStack Spacing="3">
            <!-- Header -->
            <div>
                <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>Export Your Journal Entries</strong></MudText>
                <MudText Typo="Typo.body2" Class="muted">Download entries in your preferred format with optional date range filtering</MudText>
            </div>

            <!-- Date Range Selection -->
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="From Date"
                                  Value="@_exportFromDate?.ToString("yyyy-MM-dd")"
                                  ValueChanged="@(async (string v) => await OnExportFromDateChanged(v))"
                                  Placeholder="yyyy-MM-dd"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="To Date"
                                  Value="@_exportToDate?.ToString("yyyy-MM-dd")"
                                  ValueChanged="@(async (string v) => await OnExportToDateChanged(v))"
                                  Placeholder="yyyy-MM-dd"
                                  Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>

            <!-- Export Stats -->
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                <strong>Total entries: @GetEntriesInDateRange()</strong> | 
                <strong>Words: @GetWordsInDateRange()</strong> | 
                <em>@(string.IsNullOrEmpty(_exportMessage) ? "Select format and click export" : _exportMessage)</em>
            </MudAlert>

            <!-- Export Buttons -->
            <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                <!-- PDF Export -->
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Error" 
                          Size="Size.Medium"
                          StartIcon="@Icons.Material.Filled.PictureAsPdf"
                          OnClick="@(() => ExportData("pdf"))"
                          Class="export-btn">
                    Export as PDF
                </MudButton>

                <!-- Reset Dates -->
                <MudButton Variant="Variant.Text" 
                          Color="Color.Default" 
                          Size="Size.Medium"
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="@ResetDateRange"
                          Class="export-btn">
                    Reset Dates
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudStack>

<style>
.dashboard-hero {
    padding: 2.5rem 2rem;
    margin-bottom: 2rem;
    background: linear-gradient(135deg, #1976d2, #1565c0);
    color: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(25, 118, 210, 0.25);
}

.hero-title {
    color: white;
}

.muted {
    opacity: 0.7;
}

.page-stack {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
}

.summary-card {
    padding: 1.75rem;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
}

.summary-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

:deep(.mud-dark .summary-card) {
    background-color: #424242 !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
}

:deep(.mud-dark .summary-card:hover) {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
}

.progress-bar {
    border-radius: 4px !important;
    height: 6px !important;
}

.chart-paper {
    padding: 1.75rem;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

:deep(.mud-dark .chart-paper) {
    background-color: #424242 !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
}

.chart-container {
    position: relative;
    height: 300px;
    margin-top: 1rem;
}

.details-paper {
    padding: 1.75rem;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

:deep(.mud-dark .details-paper) {
    background-color: #424242 !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stat-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 500;
}

.fire-icon {
    color: #ff6b6b;
    font-size: 24px;
}

.trophy-icon {
    color: #ffd93d;
    font-size: 24px;
}

.trend-icon {
    color: #4caf50;
    font-size: 24px;
}

.note-icon {
    color: #1976d2;
    font-size: 24px;
}

.date-icon {
    color: #9c27b0;
    font-size: 24px;
}

.timer-icon {
    color: #ff9800;
    font-size: 24px;
}

.mt-4 {
    margin-top: 1.5rem;
}

.recent-entries-paper {
    padding: 1.75rem;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

:deep(.mud-dark .recent-entries-paper) {
    background-color: #424242 !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
}

.recent-table {
    border-radius: 8px;
}

.recent-table thead {
    background: rgba(25, 118, 210, 0.05);
}

:deep(.mud-dark .recent-table thead) {
    background: rgba(100, 181, 246, 0.15) !important;
}

.recent-table tbody tr {
    transition: background-color 0.2s ease;
}

.recent-table tbody tr:hover {
    background: rgba(25, 118, 210, 0.03);
}

:deep(.mud-dark .recent-table tbody tr:hover) {
    background: rgba(100, 181, 246, 0.1) !important;
}

.mood-chip {
    border-radius: 6px !important;
}

/* ✅ EXPORT SECTION STYLES */
.export-section {
    padding: 1.75rem;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

:deep(.mud-dark .export-section) {
    background-color: #424242 !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
}

.export-btn {
    transition: all 0.3s ease;
    min-width: 140px;
}

.export-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}


</style>

@code {
private int _totalEntries = 0;
private int _currentStreak = 0;
private int _longestStreak = 0;
private int _totalWords = 0;
private List<JournalEntry> _recentEntries = new();
private Dictionary<string, int> _moodStats = new();
private List<JournalEntry> _allEntries = new();
    
// ✅ EXPORT RELATED FIELDS
private DateTime? _exportFromDate = null;
private DateTime? _exportToDate = null;
private string _exportMessage = "";


    protected override async Task OnInitializedAsync()
    {
        // Check authentication - MUST BE LOGGED IN
        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await Storage.InitializeAsync();
        await LoadDashboardData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _allEntries.Count > 0)
        {
            try
            {
                // Create mood chart
                var moodLabels = _moodStats.Keys.ToList();
                var moodData = _moodStats.Values.ToList();
                await JS.InvokeVoidAsync("createMoodChart", "moodChart", moodLabels, moodData, "doughnut");

                // Create habit chart
                var habitLabels = new[] { "Avg Words", "Entries/Month", "Consistency" };
                var habitData = new[] { GetAverageWordsPerEntry(), GetEntriesPerMonth(), GetConsistencyScore() };
                await JS.InvokeVoidAsync("createBarChart", "habitChart", habitLabels, habitData, "Writing Habits");

                // ✅ CREATE MOST USED TAGS CHART
                var tagStats = GetTopTags(10);
                if (tagStats.Count > 0)
                {
                    var tagLabels = tagStats.Keys.ToList();
                    var tagData = tagStats.Values.ToList();
                    await JS.InvokeVoidAsync("createBarChart", "tagsChart", tagLabels, tagData, "Most Used Tags");
                }

                // ✅ CREATE CATEGORY BREAKDOWN CHART
                var categoryBreakdown = GetCategoryBreakdown();
                if (categoryBreakdown.Count > 0)
                {
                    var categoryLabels = categoryBreakdown.Keys.ToList();
                    var categoryData = categoryBreakdown.Values.ToList();
                    await JS.InvokeVoidAsync("createMoodChart", "categoryChart", categoryLabels, categoryData, "doughnut");
                }

                System.Diagnostics.Debug.WriteLine("Charts created successfully");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error creating charts: {ex.Message}");
            }
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            System.Diagnostics.Debug.WriteLine("Loading dashboard data...");

            // ✅ Load statistics
            var statsResult = await Storage.GetStatisticsAsync();
            if (statsResult.Success)
            {
                _totalEntries = statsResult.Data.TotalEntries;
                _currentStreak = statsResult.Data.CurrentStreak;
                _longestStreak = statsResult.Data.LongestStreak;
                System.Diagnostics.Debug.WriteLine($"✅ Stats loaded: Entries={_totalEntries}, Current Streak={_currentStreak}, Longest={_longestStreak}");
            }
            else
            {
                System.Diagnostics.Debug.WriteLine($"❌ Stats error: {statsResult.ErrorMessage}");
            }

            // ✅ Load word count
            var wordCountResult = await Storage.GetTotalWordCountAsync();
            if (wordCountResult.Success)
            {
                _totalWords = wordCountResult.Data;
                System.Diagnostics.Debug.WriteLine($"✅ Word count loaded: {_totalWords}");
            }
            else
            {
                System.Diagnostics.Debug.WriteLine($"❌ Word count error: {wordCountResult.ErrorMessage}");
            }

            // ✅ Load recent entries
            var entriesResult = await Storage.GetAllEntriesAsync();
            if (entriesResult.Success)
            {
                _allEntries = entriesResult.Data ?? new();
                _recentEntries = _allEntries.Take(5).ToList();
                System.Diagnostics.Debug.WriteLine($"✅ Entries loaded: {_recentEntries.Count}");
            }
            else
            {
                System.Diagnostics.Debug.WriteLine($"❌ Entries error: {entriesResult.ErrorMessage}");
            }

            // ✅ Load mood stats
            LoadMoodStats();
            
            
            System.Diagnostics.Debug.WriteLine("✅ Dashboard data loading complete");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"❌ Error loading dashboard data: {ex.Message}");
        }
    }

    private void LoadMoodStats()
    {
        // Calculate mood statistics from enum values
        _moodStats = _allEntries
            .Where(e => e.Mood.HasValue)
            .GroupBy(e => e.Mood.Value.ToString())
            .OrderByDescending(g => g.Count())
            .ToDictionary(g => g.Key, g => g.Count());
    }

    private int GetAverageWordsPerEntry()
    {
        if (_totalEntries == 0) return 0;
        return _totalWords / _totalEntries;
    }

    private int GetEntriesPerMonth()
    {
        if (_totalEntries == 0) return 0;
        if (_allEntries.Count < 2) return _totalEntries;
        
        var maxDate = _allEntries.Max(e => e.Date);
        var minDate = _allEntries.Min(e => e.Date);
        var daysDiff = maxDate.DayNumber - minDate.DayNumber;
        var monthsActive = Math.Max(daysDiff / 30, 1);
        return _totalEntries / monthsActive;
    }

    
    /// ✅ GET MISSING DAYS - Days without entries in the journaling period
    
    private int GetMissingDays()
    {
        if (_totalEntries == 0) return 0;
        if (_allEntries.Count < 2) return 0;

        var maxDate = _allEntries.Max(e => e.Date);
        var minDate = _allEntries.Min(e => e.Date);
        
        // Convert DateOnly to DateTime for proper calculation
        var maxDateTime = maxDate.ToDateTime(TimeOnly.MinValue);
        var minDateTime = minDate.ToDateTime(TimeOnly.MinValue);
        
        // Total days between first and last entry (inclusive)
        var totalDays = (int)(maxDateTime - minDateTime).TotalDays + 1;
        
        // Days with entries
        var daysWithEntries = _allEntries.Select(e => e.Date).Distinct().Count();
        
        // Missing days = total days - days with entries
        var missingDays = totalDays - daysWithEntries;
        
        System.Diagnostics.Debug.WriteLine($"Missing Days: Total={totalDays}, With Entries={daysWithEntries}, Missing={missingDays}");
        return Math.Max(missingDays, 0);
    }

    private int GetConsistencyScore()
    {
        if (_longestStreak == 0) return 0;
        return Math.Min((int)((_currentStreak / (double)_longestStreak) * 100), 100);
    }

    
    /// ✅ GET TOP N MOST USED TAGS
    
    private Dictionary<string, int> GetTopTags(int count = 10)
    {
        var tagCounts = new Dictionary<string, int>();

        // Count tag usage across all entries
        foreach (var entry in _allEntries)
        {
            if (entry.Tags != null && entry.Tags.Count > 0)
            {
                foreach (var tag in entry.Tags)
                {
                    if (!string.IsNullOrEmpty(tag))
                    {
                        if (tagCounts.ContainsKey(tag))
                            tagCounts[tag]++;
                        else
                            tagCounts[tag] = 1;
                    }
                }
            }
        }

        // Return top N tags
        return tagCounts
            .OrderByDescending(x => x.Value)
            .Take(count)
            .ToDictionary(x => x.Key, x => x.Value);
    }

    
    /// Get entries count by category (using the actual Category field from JournalEntry)
    
    private Dictionary<string, int> GetCategoryBreakdown()
    {
        var categoryUsage = new Dictionary<string, int>();

        // Count entries for each category
        foreach (var entry in _allEntries)
        {
            if (!string.IsNullOrEmpty(entry.Category))
            {
                if (categoryUsage.ContainsKey(entry.Category))
                    categoryUsage[entry.Category]++;
                else
                    categoryUsage[entry.Category] = 1;
            }
        }

        System.Diagnostics.Debug.WriteLine($"Categories: {string.Join(", ", categoryUsage.Select(x => $"{x.Key}={x.Value}"))}");
        return categoryUsage;
    }

    
    /// ✅ EXPORT JOURNAL ENTRIES IN REQUESTED FORMAT WITH DATE RANGE
    
    private async Task ExportData(string format)
    {
        try
        {
            // ✅ GET ENTRIES FOR DATE RANGE
            var entriesToExport = GetEntriesInRange();

            if (entriesToExport.Count == 0)
            {
                Snackbar.Add("No entries found for selected date range", Severity.Warning);
                _exportMessage = "No entries in range";
                return;
            }

            switch (format.ToLower())
            {
                case "pdf":
                    await ExportAsPdf(entriesToExport);
                    break;
                default:
                    Snackbar.Add("Unknown export format", Severity.Error);
                    return;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            System.Diagnostics.Debug.WriteLine($"Export Exception: {ex.Message}");
        }
    }

    
    /// Export as PDF format - Beautiful PDF with entries, moods, and tags
    
    private async Task ExportAsPdf(List<JournalEntry> entries)
    {
        var result = await ExportService.ExportToPdfAsync(entries, $"Journal Export - {DateTime.Now:MMM dd, yyyy}");
        if (result.Success)
        {
            var fileName = $"journal_export_{DateTime.Now:yyyyMMdd_HHmmss}.html";
            await JS.InvokeVoidAsync("downloadFile", result.Data, fileName);
            _exportMessage = $"Exported {entries.Count} entries as PDF";
            Snackbar.Add($"Successfully exported {entries.Count} entries as PDF", Severity.Success);
        }
        else
        {
            _exportMessage = "PDF export failed";
            Snackbar.Add($"PDF export failed: {result.ErrorMessage}", Severity.Error);
        }
    }

    
    /// ✅ GET ENTRIES IN DATE RANGE
    
    private List<JournalEntry> GetEntriesInRange()
    {
        var entries = _allEntries.Where(e =>
        {
            // If no dates selected, include all entries
            if (!_exportFromDate.HasValue && !_exportToDate.HasValue)
                return true;

            var entryDate = e.Date;

            // Check from date
            if (_exportFromDate.HasValue)
            {
                var fromDate = DateOnly.FromDateTime(_exportFromDate.Value);
                if (entryDate < fromDate)
                    return false;
            }

            // Check to date
            if (_exportToDate.HasValue)
            {
                var toDate = DateOnly.FromDateTime(_exportToDate.Value);
                if (entryDate > toDate)
                    return false;
            }

            return true;
        })
        .OrderByDescending(e => e.Date)
        .ToList();

        return entries;
    }

    
    /// ✅ GET COUNT OF ENTRIES IN DATE RANGE
    
    private int GetEntriesInDateRange()
    {
        return GetEntriesInRange().Count;
    }

    
    /// ✅ GET WORD COUNT IN DATE RANGE
    
    private int GetWordsInDateRange()
    {
        return GetEntriesInRange()
            .Sum(e => GetWordCount(e.Content));
    }

    
    /// Handle From Date text input change
    
    private async Task OnExportFromDateChanged(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            _exportFromDate = null;
        }
        else if (DateTime.TryParse(value, out var date))
        {
            _exportFromDate = date;
        }
        StateHasChanged();
        await Task.CompletedTask;
    }

    
    /// Handle To Date text input change
    
    private async Task OnExportToDateChanged(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            _exportToDate = null;
        }
        else if (DateTime.TryParse(value, out var date))
        {
            _exportToDate = date;
        }
        StateHasChanged();
        await Task.CompletedTask;
    }

    
    /// Reset Date Range
    
    private void ResetDateRange()
    {
        _exportFromDate = null;
        _exportToDate = null;
        _exportMessage = "";
    }

    private int GetWordCount(string content)
    {
        if (string.IsNullOrEmpty(content)) return 0;
        return content.Split(new[] { ' ', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }
}
