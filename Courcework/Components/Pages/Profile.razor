@page "/profile"
@page "/tags"
@inject IStorageService Storage
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation
@using Courcework.Entities

<MudStack Spacing="4" Class="page-stack">
    <!-- Page Header -->
    <MudPaper Class="page-hero" Elevation="4">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h3" Class="hero-title"><strong>?? Manage Your Tags</strong></MudText>
            <MudText Typo="Typo.body2" Class="muted">Organize and customize tags for your journal entries</MudText>
        </MudStack>
    </MudPaper>

    <!-- Create New Tag Section -->
    <MudPaper Class="create-tag-section" Elevation="3">
        <MudStack Spacing="3">
            <MudText Typo="Typo.subtitle1" GutterBottom="true"><strong>? Create New Tag</strong></MudText>
            
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End">
                <MudTextField T="string" 
                             @bind-Value="_newTagName"
                             Label="Tag Name"
                             Placeholder="Enter tag name..."
                             Variant="Variant.Outlined"
                             Class="flex-grow-1" />
                
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <MudText Typo="Typo.caption" Class="muted">Color:</MudText>
                    <input type="color" @bind="_newTagColor" style="width: 50px; height: 40px; border: none; border-radius: 4px; cursor: pointer;" />
                </div>
                
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary"
                          Size="Size.Medium"
                          OnClick="@CreateNewTag"
                          StartIcon="@Icons.Material.Filled.Add">
                    CREATE TAG
                </MudButton>
            </MudStack>

            @if (!string.IsNullOrEmpty(_tagMessage))
            {
                <MudAlert Severity="@(_tagMessage.Contains("?") ? Severity.Success : Severity.Error)" 
                         Variant="Variant.Filled"
                         Dense="true">
                    @_tagMessage
                </MudAlert>
            }
        </MudStack>
    </MudPaper>

    <!-- Tag Statistics -->
    <MudGrid Spacing="3">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="stat-card" Elevation="3">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.caption" Class="muted">Total Tags</MudText>
                    <MudText Typo="Typo.h4"><strong>@_allTags.Count</strong></MudText>
                    <MudProgressLinear Value="@Math.Min(_allTags.Count / 10.0 * 100, 100)" Color="Color.Primary" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="stat-card" Elevation="3">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.caption" Class="muted">Pre-Built Tags</MudText>
                    <MudText Typo="Typo.h4"><strong>@_preBuiltCount</strong></MudText>
                    <MudProgressLinear Value="@Math.Min(_preBuiltCount / 40.0 * 100, 100)" Color="Color.Success" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="stat-card" Elevation="3">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.caption" Class="muted">Custom Tags</MudText>
                    <MudText Typo="Typo.h4"><strong>@_customCount</strong></MudText>
                    <MudProgressLinear Value="@Math.Min(_customCount / 20.0 * 100, 100)" Color="Color.Info" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="stat-card" Elevation="3">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.caption" Class="muted">Most Used</MudText>
                    <MudText Typo="Typo.h6"><strong>@_mostUsedTag</strong></MudText>
                    <MudProgressLinear Value="100" Color="Color.Warning" />
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Filter & Search -->
    <MudPaper Class="filter-section" Elevation="3">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudTextField T="string" 
                         Value="_searchTerm"
                         ValueChanged="@(async (string value) => { _searchTerm = value; FilterTags(); })"
                         Label="Search tags..."
                         Variant="Variant.Outlined"
                         StartAdornment="@Icons.Material.Filled.Search"
                         Class="flex-grow-1" />
            
            <MudSelect T="string" 
                      Value="_filterCategory"
                      ValueChanged="@(async (string value) => { _filterCategory = value; FilterTags(); })"
                      Label="Filter by category"
                      Variant="Variant.Outlined"
                      Class="flex-grow-1">
                <MudSelectItem Value="@("")">All Tags</MudSelectItem>
                <MudSelectItem Value="@("work")">Work & Career</MudSelectItem>
                <MudSelectItem Value="@("health")">Health & Fitness</MudSelectItem>
                <MudSelectItem Value="@("relationships")">Relationships</MudSelectItem>
                <MudSelectItem Value="@("personal")">Personal Growth</MudSelectItem>
                <MudSelectItem Value="@("custom")">Custom Only</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudPaper>

    <!-- Tags Display -->
    <MudPaper Class="tags-section" Elevation="3">
        <MudText Typo="Typo.subtitle1" GutterBottom="true" Class="mb-4">
            <strong>? All Tags (@_filteredTags.Count)</strong>
        </MudText>

        @if (_filteredTags.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
                No tags found matching your filters
            </MudAlert>
        }
        else
        {
            <MudGrid Spacing="2">
                @foreach (var tag in _filteredTags)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <div style="border-left: 5px solid @tag.Color; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer;" 
                             @onmouseenter="@((MouseEventArgs e) => { })"
                             class="tag-item-wrapper">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudStack Spacing="1" Style="flex: 1;">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <div style="width: 16px; height: 16px; background-color: @tag.Color; border-radius: 50%;"></div>
                                        <MudText Typo="Typo.body2"><strong>@tag.Name</strong></MudText>
                                    </MudStack>
                                    <MudText Typo="Typo.caption" Class="muted">
                                        @GetTagCategory(tag.Name)
                                    </MudText>
                                </MudStack>

                                <MudStack Row="true" Spacing="1">
                                    @if (IsCustomTag(tag.Name))
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                      Color="Color.Error"
                                                      Size="Size.Small"
                                                      OnClick="@(() => DeleteTag(tag.Id))" />
                                    }
                                    else
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Lock" 
                                                      Color="Color.Default"
                                                      Size="Size.Small"
                                                      Disabled="true"
                                                      Title="Pre-built tag" />
                                    }
                                </MudStack>
                            </MudStack>
                        </div>
                    </MudItem>
                }
            </MudGrid>
        }
    </MudPaper>

    <!-- Category Legend -->
    <MudPaper Class="legend-section" Elevation="2">
        <MudText Typo="Typo.body2" Class="mb-3"><strong>?? Tag Categories:</strong></MudText>
        <MudGrid Spacing="2">
            <MudItem xs="6" sm="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <div style="width: 12px; height: 12px; background-color: #1976d2; border-radius: 3px;"></div>
                    <MudText Typo="Typo.caption">Work & Career</MudText>
                </MudStack>
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <div style="width: 12px; height: 12px; background-color: #f44336; border-radius: 3px;"></div>
                    <MudText Typo="Typo.caption">Health & Fitness</MudText>
                </MudStack>
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <div style="width: 12px; height: 12px; background-color: #e91e63; border-radius: 3px;"></div>
                    <MudText Typo="Typo.caption">Relationships</MudText>
                </MudStack>
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <div style="width: 12px; height: 12px; background-color: #7b1fa2; border-radius: 3px;"></div>
                    <MudText Typo="Typo.caption">Personal Growth</MudText>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudStack>

<style>
.page-hero {
    padding: 2rem;
    background: linear-gradient(135deg, #1976d2, #1565c0);
    color: white;
    border-radius: 12px;
    margin-bottom: 1.5rem;
}

.hero-title {
    color: white;
}

.create-tag-section {
    padding: 1.75rem;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.stat-card {
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
}

.filter-section {
    padding: 1.5rem;
    border-radius: 10px;
}

.tags-section {
    padding: 1.75rem;
    border-radius: 10px;
}

.tag-item {
    transition: all 0.3s ease;
    cursor: pointer;
}

.tag-item:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
    transform: translateY(-2px);
}

.legend-section {
    padding: 1.5rem;
    border-radius: 10px;
    background: rgba(25, 118, 210, 0.05);
}

.flex-grow-1 {
    flex: 1;
}

.mb-3 {
    margin-bottom: 1rem;
}

.mb-4 {
    margin-bottom: 1.5rem;
}

:deep(.mud-dark .stat-card) {
    background-color: #424242 !important;
}

:deep(.mud-dark .filter-section) {
    background-color: #424242 !important;
}

:deep(.mud-dark .create-tag-section) {
    background-color: #424242 !important;
}

:deep(.mud-dark .tags-section) {
    background-color: #424242 !important;
}

:deep(.mud-dark .legend-section) {
    background-color: #3a3a3a !important;
}
</style>

@code {
    private List<Tag> _allTags = new();
    private List<Tag> _filteredTags = new();
    private string _searchTerm = "";
    private string _filterCategory = "";
    private string _newTagName = "";
    private string _newTagColor = "#1976d2";
    private string _tagMessage = "";
    private int _preBuiltCount = 0;
    private int _customCount = 0;
    private string _mostUsedTag = "—";

    protected override async Task OnInitializedAsync()
    {
        // Check authentication
        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadTags();
    }

    private async Task LoadTags()
    {
        try
        {
            var result = await Storage.GetAllTagsAsync();
            if (result.Success)
            {
                _allTags = result.Data ?? new();
                
                // Count pre-built vs custom
                var preBuiltNames = new[] { "Work", "Career", "Studies", "Projects", "Planning", "Family", "Friends", "Relationships", "Parenting", "Health", "Fitness", "Exercise", "Yoga", "Meditation", "Self-care", "Personal Growth", "Spirituality", "Reflection", "Reading", "Writing", "Hobbies", "Music", "Cooking", "Shopping", "Travel", "Nature", "Vacation", "Finance", "Birthday", "Holiday", "Celebration", "Gratitude", "Ideas" };
                
                _preBuiltCount = _allTags.Count(t => preBuiltNames.Contains(t.Name));
                _customCount = _allTags.Count - _preBuiltCount;
                
                // Get most used tag (for now, just show first)
                _mostUsedTag = _allTags.FirstOrDefault()?.Name ?? "—";
                
                FilterTags();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading tags: {ex.Message}");
        }
    }

    private void FilterTags()
    {
        _filteredTags = _allTags
            .Where(t => 
            {
                // Search filter
                if (!string.IsNullOrEmpty(_searchTerm) && 
                    !t.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))
                    return false;

                // Category filter
                if (!string.IsNullOrEmpty(_filterCategory))
                {
                    if (_filterCategory == "custom" && IsPreBuiltTag(t.Name))
                        return false;
                    
                    var category = GetTagCategory(t.Name);
                    if (!category.Contains(_filterCategory, StringComparison.OrdinalIgnoreCase))
                        return false;
                }

                return true;
            })
            .OrderBy(t => t.Name)
            .ToList();
    }

    private async Task CreateNewTag()
    {
        _tagMessage = "";

        if (string.IsNullOrWhiteSpace(_newTagName))
        {
            _tagMessage = "? Please enter a tag name";
            return;
        }

        if (_newTagName.Length > 50)
        {
            _tagMessage = "? Tag name too long (max 50 characters)";
            return;
        }

        var result = await Storage.AddTagAsync(_newTagName, _newTagColor);
        
        if (result.Success)
        {
            _tagMessage = $"? Tag '{_newTagName}' created successfully!";
            _newTagName = "";
            _newTagColor = "#1976d2";
            await LoadTags();
        }
        else
        {
            _tagMessage = $"? {result.ErrorMessage}";
        }
    }

    private async Task DeleteTag(Guid tagId)
    {
        var tag = _allTags.FirstOrDefault(t => t.Id == tagId);
        if (tag == null) return;

        if (IsPreBuiltTag(tag.Name))
        {
            _tagMessage = "? Cannot delete pre-built tags";
            return;
        }

        _allTags.Remove(tag);
        await LoadTags();
        _tagMessage = $"? Tag '{tag.Name}' deleted";
    }

    private string GetTagCategory(string tagName)
    {
        return tagName switch
        {
            "Work" or "Career" or "Studies" or "Projects" or "Planning" => "Work & Career",
            "Family" or "Friends" or "Relationships" or "Parenting" => "Relationships",
            "Health" or "Fitness" or "Exercise" or "Yoga" or "Meditation" or "Self-care" => "Health & Fitness",
            "Personal Growth" or "Spirituality" or "Reflection" or "Reading" or "Writing" => "Personal Growth",
            "Hobbies" or "Music" or "Cooking" or "Shopping" => "Hobbies & Leisure",
            "Travel" or "Nature" or "Vacation" => "Travel & Nature",
            "Finance" => "Finance",
            "Birthday" or "Holiday" or "Celebration" => "Special Events",
            "Gratitude" or "Ideas" => "Gratitude & Ideas",
            _ => "Custom"
        };
    }

    private bool IsPreBuiltTag(string tagName)
    {
        var preBuiltNames = new[] { "Work", "Career", "Studies", "Projects", "Planning", "Family", "Friends", "Relationships", "Parenting", "Health", "Fitness", "Exercise", "Yoga", "Meditation", "Self-care", "Personal Growth", "Spirituality", "Reflection", "Reading", "Writing", "Hobbies", "Music", "Cooking", "Shopping", "Travel", "Nature", "Vacation", "Finance", "Birthday", "Holiday", "Celebration", "Gratitude", "Ideas" };
        return preBuiltNames.Contains(tagName);
    }

    private bool IsCustomTag(string tagName) => !IsPreBuiltTag(tagName);
}
