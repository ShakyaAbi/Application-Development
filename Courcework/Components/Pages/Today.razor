@page "/today"
@using Courcework.Enums
@inject IStorageService Storage
@inject ICategoryService CategoryService
@inject NavigationManager Navigation
@inject IAuthenticationService AuthService
@inject IDialogService DialogService
@using Courcework.Constants

<MudStack Spacing="4" Class="page-stack">
    <!-- Alert Messages -->
    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <MudAlert Severity="Severity.Success" Variant="Variant.Filled" CloseButton="true" OnClose="@(() => _successMessage = "")">
            @_successMessage
        </MudAlert>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" CloseButton="true" OnClose="@(() => _errorMessage = "")">
            @_errorMessage
        </MudAlert>
    }

    <!-- Date Navigation Header -->
    <MudPaper Class="date-navigation" Elevation="3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" Size="Size.Small" OnClick="@PreviousDay" />
            
            <div style="text-align: center; flex: 1;">
                <MudText Typo="Typo.h6">@_currentDate.ToString("dddd, MMMM dd, yyyy")</MudText>
                <MudText Typo="Typo.caption" Class="muted">@_currentDate.ToString("dddd")</MudText>
            </div>
            
            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" OnClick="@NextDay" />
        </MudStack>
    </MudPaper>

    <!-- Quick Mood Selector -->
    <MudPaper Class="mood-selector" Elevation="3">
        <MudStack Spacing="3">
            <!-- Primary Mood by Category -->
            <div>
                <MudText Typo="Typo.body2" Class="mb-2" GutterBottom="true"><strong>Primary Mood</strong></MudText>
                
                <!-- ✅ POSITIVE MOODS -->
                <MudText Typo="Typo.caption" Class="mt-2 mb-1" Style="color: #4caf50; font-weight: bold;">Positive</MudText>
                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap" Class="mb-3">
                    @foreach (var mood in MoodConstants.PositiveMoods)
                    {
                        var moodEnum = Enum.Parse<Mood>(mood, true);
                        <MudButton Variant="@(_currentEntry?.Mood == moodEnum ? Variant.Filled : Variant.Outlined)" 
                                   Color="Color.Success" 
                                   Size="Size.Small"
                                   Class="mood-button"
                                   OnClick="@(() => { if (_currentEntry != null) { _currentEntry.Mood = moodEnum; StateHasChanged(); } })">
                            @mood
                        </MudButton>
                    }
                </MudStack>
                
                <!-- ✅ NEUTRAL MOODS -->
                <MudText Typo="Typo.caption" Class="mt-2 mb-1" Style="color: #2196f3; font-weight: bold;">Neutral</MudText>
                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap" Class="mb-3">
                    @foreach (var mood in MoodConstants.NeutralMoods)
                    {
                        var moodEnum = Enum.Parse<Mood>(mood, true);
                        <MudButton Variant="@(_currentEntry?.Mood == moodEnum ? Variant.Filled : Variant.Outlined)" 
                                   Color="Color.Info" 
                                   Size="Size.Small"
                                   Class="mood-button"
                                   OnClick="@(() => { if (_currentEntry != null) { _currentEntry.Mood = moodEnum; StateHasChanged(); } })">
                            @mood
                        </MudButton>
                    }
                </MudStack>
                
                <!-- ✅ NEGATIVE MOODS -->
                <MudText Typo="Typo.caption" Class="mt-2 mb-1" Style="color: #f44336; font-weight: bold;">Negative</MudText>
                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                    @foreach (var mood in MoodConstants.NegativeMoods)
                    {
                        var moodEnum = Enum.Parse<Mood>(mood, true);
                        <MudButton Variant="@(_currentEntry?.Mood == moodEnum ? Variant.Filled : Variant.Outlined)" 
                                   Color="Color.Error" 
                                   Size="Size.Small"
                                   Class="mood-button"
                                   OnClick="@(() => { if (_currentEntry != null) { _currentEntry.Mood = moodEnum; StateHasChanged(); } })">
                            @mood
                        </MudButton>
                    }
                </MudStack>
            </div>

            <!-- Secondary Mood (Optional with All Moods) -->
            <div>
                <MudText Typo="Typo.body2" Class="mb-2" GutterBottom="true"><strong>Secondary Mood (optional)</strong></MudText>
                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                    <MudButton Variant="@(string.IsNullOrEmpty(_currentEntry?.SecondaryMood) ? Variant.Filled : Variant.Outlined)"
                               Color="Color.Default"
                               Size="Size.Small"
                               Class="mood-button"
                               OnClick="@(() => { if (_currentEntry != null) _currentEntry.SecondaryMood = ""; StateHasChanged(); })">
                        None
                    </MudButton>
                    @foreach (var mood in MoodConstants.GetAllMoods())
                    {
                        <MudButton Variant="@(_currentEntry?.SecondaryMood == mood ? Variant.Filled : Variant.Outlined)" 
                                   Color="Color.Primary" 
                                   Size="Size.Small"
                                   Class="mood-button"
                                   OnClick="@(() => { if (_currentEntry != null) { _currentEntry.SecondaryMood = mood; StateHasChanged(); } })">
                            @mood
                        </MudButton>
                    }
                </MudStack>
            </div>
        </MudStack>
    </MudPaper>

    <!-- Entry Content -->
    <MudPaper Class="entry-content" Elevation="3">
        <MudStack Spacing="3">
            <MudTextField T="string" 
                         @bind-Value="_currentEntry.Title"
                         Label="Title (optional)" 
                         Placeholder="Give your entry a title..."
                         Variant="Variant.Outlined"
                         FullWidth="true" />
            
            <!-- Rich Text Editor Section -->
            <MudStack Spacing="2">
                <MudText Typo="Typo.body2"><strong>Write Content</strong></MudText>
                <RichTextEditor @ref="_richTextEditor" Content="@_currentEntry.Content" ContentChanged="@((string content) => _currentEntry.Content = content)" />
            </MudStack>

            <!-- Preview Section (Only for Existing Entries) -->
            @if (!string.IsNullOrEmpty(_currentEntry?.Content))
            {
                <MudDivider />
                <MudStack Spacing="2">
                    <MudText Typo="Typo.body2"><strong>Preview</strong></MudText>
                    <MudPaper Class="preview-section" Elevation="0" Outlined="true">
                        <div class="preview-content">
                            @((MarkupString)_currentEntry.Content)
                        </div>
                    </MudPaper>
                </MudStack>
            }
        </MudStack>
    </MudPaper>

    <!-- Category & Tags -->
    <MudPaper Class="category-tags" Elevation="3">
        <MudStack Spacing="3">
            <!-- Category Selection -->
            <div>
                <MudText Typo="Typo.body2" GutterBottom="true"><strong>Category</strong></MudText>
                <MudStack Spacing="2">
                    <!-- Category Group Selection -->
                    @if (_categoryGroups != null && _categoryGroups.Any())
                    {
                        <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                            @foreach (var group in _categoryGroups)
                            {
                                <MudButton Variant="@(_selectedCategoryGroup == group ? Variant.Filled : Variant.Outlined)"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => OnGroupSelected(group))">
                                    @group
                                </MudButton>
                            }
                        </MudStack>
                    }
                    
                    <!-- Category Options -->
                    @if (_categoriesInGroup != null && _categoriesInGroup.Any())
                    {
                        <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                            @foreach (var category in _categoriesInGroup)
                            {
                                <MudButton Variant="@(_currentEntry?.Category == category ? Variant.Filled : Variant.Outlined)"
                                           Color="Color.Secondary"
                                           Size="Size.Small"
                                           OnClick="@(() => { if (_currentEntry != null) _currentEntry.Category = category; })">
                                    @category
                                </MudButton>
                            }
                        </MudStack>
                    }
                </MudStack>
                
                <!-- Currently Selected Category -->
                @if (!string.IsNullOrEmpty(_currentEntry?.Category))
                {
                    <MudText Typo="Typo.caption" Class="mt-2"><strong>Selected:</strong> @_currentEntry.Category</MudText>
                }
            </div>

            <!-- Tags Selection -->
            <div>
                <MudText Typo="Typo.caption" Class="muted mb-3"><strong>Tags</strong></MudText>
                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                    @foreach (var tag in _availableTags)
                    {
                        <MudButton Variant="@(_currentEntry.Tags?.Contains(tag.Name) == true ? Variant.Filled : Variant.Outlined)"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   Class="tag-button"
                                   OnClick="@(() => ToggleTag(tag.Name))">
                            @tag.Name
                        </MudButton>
                    }
                </MudStack>
            </div>
        </MudStack>
    </MudPaper>

    <!-- Action Buttons -->
    <MudButton Variant="Variant.Filled" 
              Color="Color.Primary" 
              FullWidth="true"
              Size="Size.Large"
              Class="save-button"
              OnClick="@SaveEntry">
        Save Entry
    </MudButton>

    <MudButton Variant="Variant.Outlined" 
              Color="Color.Error" 
              FullWidth="true"
              Size="Size.Large"
              Class="delete-button"
              OnClick="@DeleteEntry"
              Disabled="@(_currentEntry?.Id == Guid.Empty)">
        Delete Entry
    </MudButton>
</MudStack>

@code {
private JournalEntry _currentEntry = new();
private DateOnly _currentDate;
private List<Tag> _availableTags = new();
private List<string> _categoryGroups = new();
private List<string> _categoriesInGroup = new();
private string _selectedCategoryGroup = "";
private string _successMessage = "";
private string _errorMessage = "";
private RichTextEditor _richTextEditor;

    protected override async Task OnInitializedAsync()
    {
        await Storage.InitializeAsync();
        
        // ✅ CHECK AUTHENTICATION - MUST BE LOGGED IN
        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        
        // Load category groups
        await LoadCategoryGroups();
        
        // Check for date parameter from URL
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryString = uri.Query;
        if (!string.IsNullOrEmpty(queryString) && queryString.Contains("date="))
        {
            var dateStr = ExtractQueryParam(queryString, "date");
            if (!string.IsNullOrEmpty(dateStr) && DateOnly.TryParse(dateStr, out var parsedDate))
            {
                _currentDate = parsedDate;
            }
            else
            {
                _currentDate = DateOnly.FromDateTime(DateTime.Today);
            }
        }
        else
        {
            _currentDate = DateOnly.FromDateTime(DateTime.Today);
        }
        
        // Load available tags
        var tagsResult = await Storage.GetAllTagsAsync();
        if (tagsResult.Success)
        {
            _availableTags = tagsResult.Data ?? new();
        }
        else
        {
            _errorMessage = tagsResult.ErrorMessage ?? "Failed to load tags";
        }

        await LoadEntryForDate();
    }

    
    /// Load all available category groups from the Category Service
    
    private async Task LoadCategoryGroups()
    {
        try
        {
            // Simplified category groups
            _categoryGroups = new List<string>
            {
                "Work", "Health", "Relationships", "Interests", "Events"
            };
            
            if (_categoryGroups.Any())
            {
                _selectedCategoryGroup = _categoryGroups.First();
                await OnGroupSelected(_selectedCategoryGroup);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading category groups: {ex.Message}");
            _errorMessage = "Failed to load categories";
        }
    }

    
    /// Load categories for the selected group
    
    private async Task OnGroupSelected(string group)
    {
        _selectedCategoryGroup = group;
        
        try
        {
            var result = await CategoryService.GetCategoriesByTypeAsync(group);
            
            if (result.Success && result.Data != null)
            {
                _categoriesInGroup = result.Data.OrderBy(c => c).ToList();
            }
            else
            {
                _categoriesInGroup = new();
                _errorMessage = result?.ErrorMessage ?? "Failed to load categories";
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading {group} categories: {ex.Message}");
            _categoriesInGroup = new();
        }
    }

    private string ExtractQueryParam(string query, string paramName)
    {
        var param = $"{paramName}=";
        var index = query.IndexOf(param);
        if (index < 0) return null;
        
        var startIndex = index + param.Length;
        var endIndex = query.IndexOf("&", startIndex);
        if (endIndex < 0) endIndex = query.Length;
        
        return query.Substring(startIndex, endIndex - startIndex);
    }

    private async Task LoadEntryForDate()
    {
        var result = await Storage.GetEntryByDateAsync(_currentDate);
        
        if (!result.Success)
        {
            _errorMessage = result.ErrorMessage ?? "Failed to load entry";
            _currentEntry = new() { Id = Guid.NewGuid(), Date = _currentDate, Tags = new() };
            return;
        }

        _currentEntry = result.Data ?? new() { Id = Guid.NewGuid(), Date = _currentDate, Tags = new() };
    }

    private async Task SaveEntry()
    {
        try
        {
            // Sync content from the RichTextEditor to ensure we have the latest
            if (_richTextEditor != null)
            {
                await _richTextEditor.SyncContentAsync();
            }

            if (string.IsNullOrWhiteSpace(_currentEntry.Content))
            {
                // Show error message
                await DialogService.ShowMessageBox(
                    "Content Required",
                    "Please write some content before saving.",
                    yesText: "OK");
                return;
            }

            // ✅ ENSURE ALL REQUIRED FIELDS ARE SET
            _currentEntry.Date = _currentDate;
            _currentEntry.IsRichText = true; // Always use rich text
            
            // ✅ ENSURE TAGS IS NOT NULL
            if (_currentEntry.Tags == null)
            {
                _currentEntry.Tags = new();
            }

            // Show confirmation dialog
            bool? result = await DialogService.ShowMessageBox(
                "Save Entry?",
                $"Save journal entry for {_currentDate:MMMM dd, yyyy}?",
                yesText: "Save",
                cancelText: "Cancel");

            if (result != true) return;

            System.Diagnostics.Debug.WriteLine($"Saving entry - Date: {_currentEntry.Date}, Content length: {_currentEntry.Content.Length}");

            var saveResult = await Storage.SaveEntryAsync(_currentEntry);
            
            if (saveResult.Success)
            {
                _successMessage = "Entry saved successfully!";
                _errorMessage = "";
                
                // Show success message
                await DialogService.ShowMessageBox(
                    "Success",
                    "Your entry has been saved successfully!",
                    yesText: "OK");
                
                System.Diagnostics.Debug.WriteLine("✅ Entry saved successfully");
            }
            else
            {
                _errorMessage = saveResult.ErrorMessage ?? "Failed to save entry";
                
                // Show error message
                await DialogService.ShowMessageBox(
                    "Error",
                    $"Failed to save entry: {_errorMessage}",
                    yesText: "OK");
                
                System.Diagnostics.Debug.WriteLine($"❌ Save failed: {_errorMessage}");
                _successMessage = "";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving entry: {ex.Message}";
            
            // Show error message
            await DialogService.ShowMessageBox(
                "Error",
                $"An error occurred: {ex.Message}",
                yesText: "OK");
            
            System.Diagnostics.Debug.WriteLine($"❌ Exception: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"❌ Inner Exception: {ex.InnerException?.Message}");
            _successMessage = "";
        }
    }

    private async Task DeleteEntry()
    {
        if (_currentEntry?.Id == Guid.Empty)
        {
            // Show error dialog
            await DialogService.ShowMessageBox(
                "No Entry",
                "There is no entry to delete.",
                yesText: "OK");
            return;
        }

        // Show confirmation dialog
        bool? result = await DialogService.ShowMessageBox(
            "Delete Entry?",
            $"Are you sure you want to delete this entry for {_currentDate:MMMM dd, yyyy}? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result != true) return;

        var deleteResult = await Storage.DeleteEntryAsync(_currentEntry.Id);
        
        if (deleteResult.Success)
        {
            _successMessage = "Entry deleted successfully!";
            _errorMessage = "";
            _currentEntry = new() { Id = Guid.NewGuid(), Date = _currentDate, Tags = new() };
            
            // Show success dialog
            await DialogService.ShowMessageBox(
                "Success",
                "Your entry has been deleted successfully!",
                yesText: "OK");
        }
        else
        {
            _errorMessage = deleteResult.ErrorMessage ?? "Failed to delete entry";
            
            // Show error dialog
            await DialogService.ShowMessageBox(
                "Error",
                $"Failed to delete entry: {_errorMessage}",
                yesText: "OK");
            
            _successMessage = "";
        }
    }

    private void PreviousDay()
    {
        _currentDate = _currentDate.AddDays(-1);
        _ = LoadEntryForDate();
    }

    private void NextDay()
    {
        _currentDate = _currentDate.AddDays(1);
        _ = LoadEntryForDate();
    }

    private void ToggleTag(string tagName)
    {
        if (_currentEntry.Tags == null)
        {
            _currentEntry.Tags = new();
        }

        if (_currentEntry.Tags.Contains(tagName))
        {
            _currentEntry.Tags.Remove(tagName);
        }
        else
        {
            _currentEntry.Tags.Add(tagName);
        }
    }
}

<style>
.page-stack {
    max-width: 700px;
    margin: 0 auto;
    padding: 1rem;
}

.date-navigation {
    padding: 2rem 1.5rem;
    background: linear-gradient(135deg, rgba(25, 118, 210, 0.08), rgba(25, 118, 210, 0.04));
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

:deep(.mud-dark .date-navigation) {
    background: linear-gradient(135deg, rgba(100, 181, 246, 0.1), rgba(100, 181, 246, 0.05)) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
}

.mood-selector {
    padding: 2rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

:deep(.mud-dark .mood-selector) {
    background-color: #424242 !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;
}

.mood-button {
    padding: 0.75rem 1.25rem !important;
    border-radius: 8px !important;
    transition: all 0.3s ease !important;
}

.mood-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(25, 118, 210, 0.2) !important;
}

:deep(.mud-dark .mood-button:hover) {
    box-shadow: 0 6px 20px rgba(100, 181, 246, 0.3) !important;
}

.entry-content {
    padding: 2rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

:deep(.mud-dark .entry-content) {
    background-color: #424242 !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;
}

.category-tags {
    padding: 2rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

:deep(.mud-dark .category-tags) {
    background-color: #424242 !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;
}

.tag-button {
    padding: 0.5rem 1rem !important;
    border-radius: 8px !important;
}

.action-buttons {
    padding: 2rem 0 1rem 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.save-button, .delete-button {
    border-radius: 10px !important;
    padding: 1rem 1.5rem !important;
    font-weight: 600 !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    transition: all 0.3s ease !important;
    margin-bottom: 0.5rem;
}

.save-button:hover, .delete-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2) !important;
}

:deep(.mud-dark .save-button:hover),
:deep(.mud-dark .delete-button:hover) {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4) !important;
}

.muted {
    opacity: 0.7;
}

.mb-3 {
    margin-bottom: 1rem;
}

.preview-section {
    padding: 1.5rem;
    border-radius: 8px;
    background-color: rgba(25, 118, 210, 0.02);
    border: 1px solid rgba(25, 118, 210, 0.15);
}

:deep(.mud-dark .preview-section) {
    background-color: rgba(100, 181, 246, 0.05) !important;
    border-color: rgba(100, 181, 246, 0.25) !important;
}

.preview-content {
    line-height: 1.8;
    color: inherit;
    word-wrap: break-word;
}

.preview-content :deep(p) {
    margin: 0.75rem 0;
}

.preview-content :deep(strong) {
    font-weight: 600;
}

.preview-content :deep(em) {
    font-style: italic;
}

.preview-content :deep(u) {
    text-decoration: underline;
}

.preview-content :deep(ul),
.preview-content :deep(ol) {
    margin-left: 1.5rem;
    margin-top: 0.75rem;
    margin-bottom: 0.75rem;
}

.preview-content :deep(li) {
    margin: 0.5rem 0;
}
</style>
